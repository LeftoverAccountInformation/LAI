embedded_svc.defineFeature("LiveAgent",function(esw){var VISITOR_INFO_KEY="LA_VISITOR_INFO",AVAILABILITY_PING_TIMEOUT=5e3,AVAILABILITY_PING_RATE=5e4,SCRT_API_VERSION=36,INVITE_DOM_ID="snapins_invite";function Noun(e,t){this.name=e,this.data=t}function SCRTConnection(e){this.liveAgentAPI=e,this.running=!1,this.pingTimeoutTimer=void 0,this.pingScript=void 0,this.sid=esw.getCookie("liveagent_sid")}function FileTransfer(){this.createElements(),this.registerMessageHandlers()}function VisitorInfo(){this.visitCount=0,this.originalReferrer=void 0,this.pages=[]}function LiveAgentAPI(){this.connection=new SCRTConnection(this),this.fileTransfer=new FileTransfer,this.visitorInfo=new VisitorInfo,esw.setDefaultButtonText("LiveAgent","Chat with an Expert","Agent Offline","Live chat:"),esw.addDefaultSetting("avatarImgURL",""),esw.addDefaultSetting("prechatBackgroundImgURL",""),esw.addDefaultSetting("waitingStateBackgroundImgURL",""),esw.addDefaultSetting("smallCompanyLogoImgURL",""),esw.addDefaultSetting("headerBackgroundURL",""),esw.addDefaultSetting("extraPrechatInfo",[]),esw.addDefaultSetting("extraPrechatFormDetails",[]),esw.addDefaultSetting("agentAvailableOnButtonClick",!1),esw.settings.isOfflineSupportEnabled&&(esw.settings.offlineSupportMinimizedText=esw.settings.offlineSupportMinimizedText||"Contact Us"),esw.addMessageHandler("liveagent.chatCanceledOnDifferentTab",function(){esw.fireEvent("liveagent.chatCanceledOnDifferentTab")}),esw.addEventHandler("error",this.disconnect.bind(this)),esw.addEventHandler("sessionDataRetrieved",function(e){return e.CHASITOR_SERIALIZED_KEY?(esw.settings.agentAvailableOnButtonClick=!0,this.ping()):esw.loadFeatureScript("Invite",function(){embedded_svc.liveAgentAPI.getButtonSettings(),esw.loadScriptFromDirectory("utils","inert")}),this.visitorInfo.initialize(e),!!e.CHASITOR_SERIALIZED_KEY}.bind(this)),esw.addEventHandler("beforeCreate",function(){esw.settings.visitorInfo=this.visitorInfo.getInfo()}.bind(this)),esw.addEventHandler("validateInit",function(e){if("string"!=typeof e.baseLiveAgentURL)throw new Error("Invalid Live Agent chat URL: "+e.baseLiveAgentURL);if("string"!=typeof e.baseLiveAgentContentURL)throw new Error("Invalid Live Agent content URL: "+e.baseLiveAgentContentURL);if(!this.isButtonId(e.buttonId))throw new Error("Invalid ButtonId Parameter Value: "+e.buttonId);if(!this.isDeploymentId(e.deploymentId))throw new Error("Invalid DeploymentId Parameter Value: "+e.deploymentId);return!0}.bind(this)),esw.loadStorageScript("Chasitor"),esw.registerStorageKeys(["CHASITOR_SERIALIZED_KEY","LA_ESW_CHAT_SCROLL_POSITION","LA_ESW_UNSEEN_MESSAGES","LA_ESW_SHOW_QUEUE_POSITION","LA_VISITOR_INFO","LA_ESW_FILE_TOKEN","LA_ESW_FILE_UPLOAD_SERVLET_URL","CHATBOT_FOOTER_MENU"]),"LiveAgent"===esw.settings.entryFeature&&this.updateButton()}function jsonDecode(str){var escape=/[\u0000\u00ad\u0600-\u0604\u070f\u17b4\u17b5\u200c-\u200f\u2028-\u202f\u2060-\u206f\ufeff\ufff0-\uffff]/g,returnStr=String(str);if(void 0!==window.JSON)return window.JSON.parse(returnStr);if(escape.lastIndex=0,escape.test(str)&&(returnStr=returnStr.replace(escape,function(e){return"\\u"+("0000"+e.charCodeAt(0).toString(16)).slice(-4)})),/^[\],:{}\s]*$/.test(str.replace(/\\(?:["\\\/bfnrt]|u[0-9a-fA-F]{4})/g,"@").replace(/"[^"\\\n\r]*"|true|false|null|-?\d+(?:\.\d*)?(?:[eE][+\-]?\d+)?/g,"]").replace(/(?:^|:|,)(?:\s*\[)+/g,"")))return eval("("+returnStr+")");throw new Error("Error during JSON.parse")}function handleInviteButton(e){var t,n=jsonDecode(e.inviteRules);(t=document.getElementById(INVITE_DOM_ID))&&esw.inviteAPI&&"Custom"!==e.inviteRenderer&&(esw.inviteAPI.inviteButton.addTracker(t,e),esw.inviteAPI.inviteButton.setRules(n.rules,n.filter),esw.inviteAPI.inviteButton.setOnlineState(e.isAvailable))}SCRTConnection.prototype.send=function(e,t){var n,i,s=t||{},o="Visitor",r="",a=!1;this.pingScript?this.onError("SCRT did not handle response before sending another message."):(1<e.length?(o="System",r="MultiNoun",s.nouns="",a=!0):r=e[0].name,n=esw.settings.baseLiveAgentURL+"/rest/"+o+"/"+r+".jsonp?",e.forEach(function(t){a&&(s.nouns+=t.name+","),s[t.name+".prefix"]="Visitor",Object.getOwnPropertyNames(t.data).forEach(function(e){s[t.name+"."+e]=t.data[e]})}),a&&(s.nouns=s.nouns.substr(0,s.nouns.length-1)),Object.getOwnPropertyNames(s).forEach(function(e){n+=e+"="+s[e]+"&"}),n+="callback=embedded_svc.liveAgentAPI.connection.handlePing&deployment_id="+esw.settings.deploymentId+"&org_id="+esw.settings.orgId+"&version="+SCRT_API_VERSION,(i=document.createElement("script")).type="text/javascript",i.src=n,this.pingScript=document.body.appendChild(i),this.pingTimeoutTimer=window.setTimeout(function(){this.onError("Server failed to respond.")}.bind(this),AVAILABILITY_PING_TIMEOUT))},SCRTConnection.prototype.handlePing=function(e){this.pingTimeoutTimer&&(clearTimeout(this.pingTimeoutTimer),this.pingTimeoutTimer=void 0),this.running=!0,e.messages.forEach(function(e){this.messageHandler(e.type,e.message)}.bind(this)),this.onSuccess(),this.pingScript&&(document.body.removeChild(this.pingScript),this.pingScript=void 0)},SCRTConnection.prototype.messageHandler=function(e,t){switch(e){case"Availability":this.liveAgentAPI.handleAvailability(t);break;case"SwitchServer":this.liveAgentAPI.handleSwitchServer(t);break;case"Settings":this.liveAgentAPI.handleSettings(t);break;default:esw.log("Unexpected message of type "+e+": "+JSON.stringify(t))}},SCRTConnection.prototype.onSuccess=function(e){var t=e||AVAILABILITY_PING_RATE;this.pingTimer&&clearTimeout(this.pingTimer),this.pingTimer=window.setTimeout(this.liveAgentAPI.ping.bind(this.liveAgentAPI),t)},SCRTConnection.prototype.onError=function(e){esw.error(e)},FileTransfer.prototype.registerMessageHandlers=function(){esw.addMessageHandler("liveagent.fileTransfer.openFileSelector",function(){this.openFileSelector()}.bind(this)),esw.addMessageHandler("liveagent.fileTransfer.uploadFile",function(e){this.uploadFile(e)}.bind(this)),esw.addMessageHandler("liveagent.fileTransfer.resetFileSelector",function(){this.resetFileSelector()}.bind(this))},FileTransfer.prototype.openFileSelector=function(){document.getElementById("fileSelector").click()},FileTransfer.prototype.handleFileSelectorChange=function(){var e=document.getElementById("fileSelector").files[0];embedded_svc.liveAgentAPI.sendFileInfo(e)},FileTransfer.prototype.uploadFile=function(e){var t=document.getElementById("fileUploadForm");t.action=e.url,t.submit(),this.resetFileSelector()},FileTransfer.prototype.resetFileSelector=function(){document.getElementById("fileSelector").value=""},FileTransfer.prototype.createElements=function(){var e=document.createElement("form"),t=document.createElement("input"),n=document.createElement("input"),i=document.createElement("iframe");e.id="fileUploadForm",e.enctype="multipart/form-data",e.method="post",e.target="fileUploadIframe",t.type="file",t.id="fileSelector",t.name="file",t.style.display="none",t.onchange=this.handleFileSelectorChange,n.name="filename",n.type="hidden",i.id="fileUploadIframe",i.name="fileUploadIframe",i.title="FileUploadFrame",i.style.display="none",e.appendChild(t),e.appendChild(n),document.body.appendChild(e),document.body.appendChild(i)},VisitorInfo.prototype.initialize=function(e){var t;e&&e[VISITOR_INFO_KEY]?(t=JSON.parse(e[VISITOR_INFO_KEY]),this.visitCount=t.visitCount,this.pages=t.pages,this.originalReferrer=t.originalReferrer||document.referrer):this.originalReferrer=document.referrer,this.visitCount+=1,this.addCurrentPage(),this.serialize()},VisitorInfo.prototype.serialize=function(){var e=JSON.stringify({visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages});embedded_svc?embedded_svc.setSessionData(VISITOR_INFO_KEY,e):window.sessionStorage.setItem(VISITOR_INFO_KEY,e)},VisitorInfo.prototype.getInfo=function(){return{visitCount:this.visitCount,originalReferrer:this.originalReferrer,pages:this.pages}},VisitorInfo.prototype.addCurrentPage=function(){var n=window.location.href;this.pages.forEach(function(e,t){e.location===n&&this.pages.splice(t,1)}.bind(this)),this.pages.unshift({location:n,time:(new Date).getTime()})},LiveAgentAPI.prototype.ping=function(){var e={},t=[new Noun("Availability",{ids:"["+esw.settings.buttonId+"]"})];esw.log("Pinging server"),this.connection.pingTimer=void 0,e.sid=this.sid,e.r=(new Date).getMilliseconds(),this.connection.send(t,e)},LiveAgentAPI.prototype.getButtonSettings=function(){var e=[],t={};this.sid&&(t.sid=this.sid,t.r=(new Date).getMilliseconds(),esw.log("Reusing existing session.")),e.push(new Noun("Settings",{buttonIds:"["+esw.settings.buttonId+"]",updateBreadcrumb:1})),this.connection.send(e,t)},LiveAgentAPI.prototype.handleAvailability=function(e){esw.log("Agent Available: "+JSON.stringify(e)),e.results.forEach(function(e){var t=e.isAvailable;"LiveAgent"===esw.settings.entryFeature&&(esw.settings.agentAvailableOnButtonClick=t,this.updateButton(t),esw.inviteAPI&&esw.inviteAPI.inviteButton.getTracker()&&esw.inviteAPI.inviteButton.setOnlineState(t))}.bind(this))},LiveAgentAPI.prototype.handleSettings=function(e){var t,n;e.buttons.forEach(function(e){e.id===esw.settings.buttonId&&(t=e.isAvailable,"Invite"===e.type&&(n=e))}),esw.log("Agent Available: "+JSON.stringify(t)),"LiveAgent"===esw.settings.entryFeature&&(esw.settings.agentAvailableOnButtonClick=t,this.updateButton(t)),n&&handleInviteButton(n)},LiveAgentAPI.prototype.handleSwitchServer=function(e){var t=e.newUrl;esw.log("Detected new Live Agent url: "+t),esw.settings.baseLiveAgentURL=t,esw.log("Immediately re-pinging server with new Live Agent url"),window.setTimeout(function(){this.connection.onSuccess(1)}.bind(this),1),this.getButtonSettings()},LiveAgentAPI.prototype.disconnect=function(){esw.log("Disconnecting from Live Agent"),this.connection.running=!1},LiveAgentAPI.prototype.isButtonId=function(e){return"573"===esw.getKeyPrefix(e)},LiveAgentAPI.prototype.isDeploymentId=function(e){return"572"===esw.getKeyPrefix(e)},LiveAgentAPI.prototype.sendFileInfo=function(e){var t=document.createEvent("CustomEvent");t.initCustomEvent("sendFileInfo",!0,!1,{name:e.name,size:e.size}),window.dispatchEvent(t)},LiveAgentAPI.prototype.sendCustomEvent=function(e,t){var n={};n.type=e,n.data=t,esw.postMessage("chasitor.sendCustomEvent",n)},LiveAgentAPI.prototype.getCustomEvents=function(e){esw.addMessageHandler("liveagent.getCustomEventsResult",e),esw.postMessage("chasitor.getCustomEvents")},LiveAgentAPI.prototype.addCustomEventListener=function(e,t){esw.addMessageHandler("liveagent.customEventReceived",t),esw.postMessage("chasitor.addCustomEventListener",e)},LiveAgentAPI.prototype.getSessionId=function(){return this.sid},LiveAgentAPI.prototype.updateButton=function(e){esw.settings.isOfflineSupportEnabled&&!e?(esw.isButtonDisabled=!1,esw.setHelpButtonText(esw.settings.offlineSupportMinimizedText)):esw.isButtonDisabled=!e},esw.liveAgentAPI=new LiveAgentAPI});