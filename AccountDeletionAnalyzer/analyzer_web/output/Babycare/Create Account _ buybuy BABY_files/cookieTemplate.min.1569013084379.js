var ChatManager=function($,_){var basePath;var pageType;var retailerMode;var currentUser=null;var selectedStoreIdentifier;var isQueueActive;var currentAndNearbyStoresResponse=null;var apiUrl;var references={};var activeChatRequests;var chatId;var activeChat;var webHost;var dispatchList=[];var currentRetailer;var selectSpecialty;var locale;var notifiedReps=[];function initialize(firebaseInstance,options){if(options.environment==="travis"){options.environment="int"}apiUrl=options.apiUrl;basePath=firebaseInstance+options.environment+"/"+options.retailer;currentRetailer=options.retailer;retailerMode=options.retailerMode;selectedStoreIdentifier=options.currentStoreIdentifier;pageType=options.pageType||"store";isQueueActive=options.isQueueActive||false;webHost=options.webHost;locale=options.locale;selectSpecialty=options.selectSpecialty;if(pageType==="rep"&&retailerMode==="rep"){currentUser=options.currentUser}}function addNotifiedRep(user){notifiedReps.push(user)}function cleanRepList(repList){if(isQueueActive){return repList.slice(0,3)}return repList}function enableAndAddToQueue(store,user){return $.post(apiUrl+"/chat/connect/"+store+"/"+user)}function disableAndRemoveFromQueue(store,user){return $.post(apiUrl+"/chat/disconnect/"+store+"/"+user)}function getFirebaseReference(path,refresh){path="/"+path.replace(/^\//,path);if(!references.hasOwnProperty(path)||refresh===true){references[path]=new Firebase(basePath+path)}return references[path]}function getStoreList(){if(getChatRoutingStrategy()==="queue"){return $.Deferred().resolve([{identifier:selectedStoreIdentifier}])}else{if(_.isEmpty(currentAndNearbyStoresResponse)){return $.ajax({type:"GET",url:apiUrl+"/chat/stores/"+selectedStoreIdentifier,contentType:"application/json;charset=UTF-8",dataType:"json"}).then(function(response){currentAndNearbyStoresResponse=response;return response})}else{return $.Deferred().resolve(currentAndNearbyStoresResponse)}}}function getChatRoutingStrategy(){return isQueueActive?"queue":"broadcast"}function getConnectedReps(onAfterRepList,byStore){if(_.isUndefined(byStore)){byStore=true}getStoreList().then(function(response){var closestStores=_.map(response,function(store){return store.identifier});getFirebaseReference("presence/").once("value").then(function(presence){var repsByStore=_.pick(presence.val(),closestStores);return _.mapObject(repsByStore,function(reps){return _.keys(_.pick(reps,function(repStatus){return repStatus===true||_.isObject(repStatus)||repStatus==="unavailable"}))})}).then(function(repsByStore){if(byStore){return repsByStore}return _.reduce(repsByStore,function(repList,storeList){repList.push(storeList);return _.flatten(repList)},[])}).then(onAfterRepList)})}function sendChatRequest(meta,eventCallbacks){activeChatRequests={};if(isRepModeStorefront()){return sendSingleRepTargetChatRequest(meta.targetRep,eventCallbacks)}if(getChatRoutingStrategy()==="broadcast"){return sendBroadcastChatRequest(meta.specialty,eventCallbacks)}else if(getChatRoutingStrategy()==="queue"){return sendQueueChatRequest(meta.specialty,eventCallbacks)}}function sendBroadcastChatRequest(specialty,eventCallbacks){getStoreList().then(function(response){_.each(response,function(store){var request=createChatRequest(store.identifier);createChatMetaRequest(store.identifier,request,specialty);if(eventCallbacks.hasOwnProperty("onAfterRequestCreated")){eventCallbacks.onAfterRequestCreated()}bindOnRequestAnsweredEvents(store.identifier,request,eventCallbacks.onAnswer)});if(eventCallbacks.hasOwnProperty("onAfterAllRequestsCreated")){eventCallbacks.onAfterAllRequestsCreated()}})}function sendQueueChatRequest(specialty,eventCallbacks){var request=createChatRequest(selectedStoreIdentifier);createChatMetaRequest(selectedStoreIdentifier,request,specialty);bindOnRequestAnsweredEvents(selectedStoreIdentifier,request,eventCallbacks.onAnswer);if(eventCallbacks.hasOwnProperty("onAfterRequestCreated")){eventCallbacks.onAfterRequestCreated()}if(eventCallbacks.hasOwnProperty("onAfterAllRequestsCreated")){eventCallbacks.onAfterAllRequestsCreated()}}function sendSingleRepTargetChatRequest(targetRep,eventCallbacks){var request=createChatRequest(targetRep);createChatMetaRequest(targetRep,request,null);bindOnRequestAnsweredEvents(targetRep,request,eventCallbacks.onAnswer);if(eventCallbacks.hasOwnProperty("onAfterRequestCreated")){eventCallbacks.onAfterRequestCreated()}if(eventCallbacks.hasOwnProperty("onAfterAllRequestsCreated")){eventCallbacks.onAfterAllRequestsCreated()}}function bindOnRequestAnsweredEvents(storeIdentifier,request,onAnswerCallback){request.on("value",_.partial(function(storeIdentifier,snapshot){if(snapshot.val()===null){var roomId=getActiveChatId();if(!isRepModeStorefront()){terminateActiveRequests(storeIdentifier)}createChatRoom(roomId,storeIdentifier);disableAbandonLogger();getActiveChatMetaRef().set({store:storeIdentifier,room:roomId,locale:locale});onAnswerCallback(snapshot)}},storeIdentifier))}function createChatRequest(target){activeChatRequests[target]={};var requestsParent=getChatRequestsReference(target);var newRequest;if(_.isEmpty(chatId)){newRequest=requestsParent.push();chatId=newRequest.key()}else{newRequest=requestsParent.child(chatId)}newRequest.set(Firebase.ServerValue.TIMESTAMP);newRequest.onDisconnect().remove();activeChatRequests[target].request=newRequest;prepareAbandonLogger(target);return newRequest}function prepareAbandonLogger(target){var ref=getCurrentChatAbandonRef();ref.child("start").set(Firebase.ServerValue.TIMESTAMP);ref.child(getRequestType()).set(target);ref.child("abandon").onDisconnect().set(Firebase.ServerValue.TIMESTAMP)}function disableAbandonLogger(){getCurrentChatAbandonRef().onDisconnect().cancel();getCurrentChatAbandonRef().remove()}function getCurrentChatAbandonRef(){return getFirebaseReference("abandon/"+getActiveChatId())}function createChatMetaRequest(target,request,specialty){if(!retailerHasSpecialties()){return}if(specialty===null||specialty===""){specialty="all"}var metaRequest={};metaRequest[request.key()]={category:specialty};var metaRequestRef=getChatMetaRequestsReference(target);metaRequestRef.update(metaRequest);metaRequestRef.child(request.key()).onDisconnect().remove();activeChatRequests[target].metaRequest=metaRequestRef}function reloadChat(roomId,onAfterChatReload){chatId=roomId;return getActiveChatReference(roomId).once("value",function(snapshot){var data=snapshot.val();createChatRoom(roomId,data.meta.store);onAfterChatReload(snapshot.val())})}function createChatRoom(roomId,storeIdentifier){var roomRef=getActiveChatReference(roomId);activeChat={id:roomId,store:storeIdentifier,room:roomRef,meta:roomRef.child("meta"),customer:roomRef.child("customer"),rep:roomRef.child("rep"),messages:roomRef.child("messages")};return getActiveChat()}function getActiveChatReference(roomId){return getFirebaseReference("message/"+roomId)}function getActiveChat(){return activeChat}function getActiveChatId(){return chatId}function getActiveChatMetaRef(){return getActiveChat().meta}function getActiveChatStore(){return getActiveChatMetaRef().store}function getActiveChatCustomerRef(){return getActiveChat().customer}function hasActiveChat(){return!_.isEmpty(getActiveChat())}function getActiveChatRepRef(){return getActiveChat().rep}function getActiveChatMessagesRef(){return getActiveChat().messages}function terminateActiveRequests(excludedStore){var requestsToTerminate=_.omit(activeChatRequests,excludedStore);_.each(requestsToTerminate,function(request){if(!_.contains(excludedStore,request.room)){request.request.off();request.request.remove()}})}function getCurrentRequestReferenceForStore(storeIdentifier){return activeChatRequests[storeIdentifier].request}function retailerHasSpecialties(){return selectSpecialty}function isRepMode(){return retailerMode==="rep"}function isRepModeStorefront(){return isRepMode()&&pageType==="rep"}function getChatRequestsReference(target){var type=getRequestType();return getFirebaseReference("request/"+type+"/"+target)}function getRequestType(){var type=pageType==="store"?"stores":"reps";if(isTeamModeBroadcast()){type="stores"}return type}function isTeamModeBroadcast(){return getChatRoutingStrategy()==="broadcast"&&retailerMode==="store"}function getChatMetaRequestsReference(target){var type=pageType==="store"?"stores":"reps";return getFirebaseReference("meta-request/"+type+"/"+target)}function sendGenericMessage(messageText,type,displayTo,user){displayTo=displayTo||"rep, customer";var message=getActiveChatMessagesRef().push();message.set({type:type,message:messageText,timestamp:Firebase.ServerValue.TIMESTAMP,displayTo:displayTo,repLogin:user.currentUser,rep:user.currentUserName});getActiveChatRepRef().child("typing").set(false)}function setTypingState(reference,state){if(_.isUndefined(state)){state=true}reference.child("typing").set(state)}function setRepIsTyping(state){setTypingState(getActiveChatRepRef(),state)}function setCustomerIsTyping(state){setTypingState(getActiveChatCustomerRef(),state)}function sendFlaggedChatAlert(){getActiveChatRepRef().child("isConnected").set("flaggedChat")}function sendtransferredChat(){getActiveChatRepRef().child("isConnected").set("transferredChat")}function serializeHistory(user){getActiveChatMetaRef().once("value",function(snapshot){var data=snapshot.val();var store=data.store;var ref=getFirebaseReference("room/"+store+"/"+user+"/"+getActiveChatId()+"/timestamp");ref.once("value",function(snapshot){if(snapshot.val()===null){ref.set(Firebase.ServerValue.TIMESTAMP)}})})}function disconnect(){disableAbandonLogger();Firebase.goOffline()}function getSelectedStoreQueueRef(){return getFirebaseReference("queue/"+selectedStoreIdentifier)}function getStorePresenceRef(storeIdentifier){return getFirebaseReference("presence/"+storeIdentifier)}function getSelectedStorePresenceRef(){return getStorePresenceRef(selectedStoreIdentifier)}function logEvent(id,eventType){var sfid=$("#sf-vars").data("sfid");var args={type:eventType,uniq_id:sfid,customer_id:"0",attributes:"",satisfied:"0",event_id:"0"};if(pageType==="store"){args.store_id=id}else{args.user_id=id}var options={method:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify(args),dataType:"json",processData:false};return $.ajax(apiUrl+"/events",options)}function logManualChatRedirect(){var eventId=84;if(pageType==="store"){_.each(dispatchList,function(storeIdentifier){logEvent(storeIdentifier,eventId)})}else{logEvent(currentUser,eventId)}}function logAutomaticChatRedirect(onAfterLogEvent){var eventId=86;if(pageType==="store"){_.each(dispatchList,function(storeIdentifier){logEvent(storeIdentifier,eventId)})}else{logEvent(currentUser,eventId)}if(_.isFunction(onAfterLogEvent)){onAfterLogEvent()}}function logChatHeartbeat(){var eventId=85;if(pageType==="store"){_.each(dispatchList,function(storeIdentifier){logEvent(storeIdentifier,eventId)})}else{logEvent(currentUser,eventId)}}function addStoreToDispatchList(storeIdentifier){if(!_.contains(dispatchList,storeIdentifier)){dispatchList.push(storeIdentifier)}}function sendRepMissedChat(storeIdentifier,repName){if(pageType==="store"&&_.indexOf(notifiedReps,repName)===-1){return $.Deferred().resolve({})}return $.post(apiUrl+"/chat/miss/"+storeIdentifier+"/"+repName)}function sendMissedChat(repList,repsFilter){if(_.isString(repList)){sendRepMissedChat(selectedStoreIdentifier,repList);return}if(pageType==="rep"){sendRepMissedChat(selectedStoreIdentifier,currentUser);return}if(getChatRoutingStrategy()==="queue"){_.each(repList,_.bind(function(rep){sendRepMissedChat(selectedStoreIdentifier,rep)},this))}else{getConnectedReps(function(response){_.each(response,function(reps,storeIdentifier){reps=_.isFunction(repsFilter)?repsFilter(reps):$.when(reps);reps.then(function(reps){_.each(reps,function(userName){sendRepMissedChat(storeIdentifier,userName)})})})},true)}}return{initialize:initialize,addNotifiedRep:addNotifiedRep,addStoreToDispatchList:addStoreToDispatchList,cleanRepList:cleanRepList,disableAbandonLogger:disableAbandonLogger,disableAndRemoveFromQueue:disableAndRemoveFromQueue,disconnect:disconnect,enableAndAddToQueue:enableAndAddToQueue,getActiveChatCustomerRef:getActiveChatCustomerRef,getActiveChatId:getActiveChatId,getActiveChatMetaRef:getActiveChatMetaRef,getActiveChatMessagesRef:getActiveChatMessagesRef,getActiveChatRepRef:getActiveChatRepRef,getConnectedReps:getConnectedReps,getCurrentRequestReferenceForStore:getCurrentRequestReferenceForStore,getSelectedStorePresenceRef:getSelectedStorePresenceRef,getSelectedStoreQueueRef:getSelectedStoreQueueRef,hasActiveChat:hasActiveChat,logAutomaticChatRedirect:logAutomaticChatRedirect,logChatHeartbeat:logChatHeartbeat,logManualChatRedirect:logManualChatRedirect,reloadChat:reloadChat,retailerHasSpecialties:retailerHasSpecialties,sendChatRequest:sendChatRequest,sendFlaggedChatAlert:sendFlaggedChatAlert,sendtransferredChat:sendtransferredChat,sendGenericMessage:sendGenericMessage,sendMissedChat:sendMissedChat,serializeHistory:serializeHistory,setRepIsTyping:setRepIsTyping,terminateActiveRequests:terminateActiveRequests}};var BaseView=Backbone.View.extend({defaultEvents:{"click .sf-service-trigger, .js-service-trigger":"openService"},initialize:function(){var self=this,method=window.addEventListener?"addEventListener":"attachEvent",message=window.addEventListener?"message":"onmessage";window[method](message,function(event){self.handleMessage(event)},false);_.extend(this.events,BaseView.prototype.defaultEvents);this.initVars();this.initFirebase();this.initMultilang()},initChatManager:function(){this.ChatManager=new ChatManager($,_);this.ChatManager.initialize(this.firebaseInstance,{apiUrl:this.api,environment:this.currentEnv,retailer:this.currentRetailer,pageType:this.currentType,retailerMode:this.currentMode,currentUser:this.currentUser,currentStoreIdentifier:this.currentStoreIdentifier,isQueueActive:this.isQueueActive,webHost:this.webHost,locale:this.getVar("sf-locale"),selectSpecialty:this.selectSpecialty,repsHaveSpecialty:this.repsHaveSpecialty})},initMultilang:function(){var lng=this.getVar("sf-locale");var lngFallBack=this.getVar("sf-locale-fallback")?this.getVar("sf-locale-fallback"):lng;if(window.i18nloaded){return}window.i18nloaded=true;window.i18next.init({debug:false,lng:lng,fallbackLng:lngFallBack,resources:{en_US:{translation:{dropdown_all_specialties:"All Specialties",dropdown_any_specialties:"Any Specialties",categories_and:" and ",categories_other:" and other specialties",customer_email_validation:"Please enter a valid email",virtual_store_ambassador:"Ambassador - {{name}}",user_type_customer:"Customer",button_connect:"CONNECT",button_leave_message:"LEAVE A MESSAGE",and:"and",carousel_located:"are located in",carousel_rep_text:"{{name}} is available now.",chat_quit_active:"You are about to leave an active chat session.",chat_message_sent:"Sent. Not seen yet.",chat_missed_request:"You missed a chat request, you are now offline.",chat_session_disconnected:"The chat session has been disconnected",chat_customer_idle:"Your Customer is idle",chat_customer_left:"Your Customer has left the chat",chat_customer_active:"The Customer is no longer idle",chat_customer_disconnected:"Your Customer got disconnected",chat_request_neutral:"Incoming Chat Request for {{store}}",chat_request_sidebar:"Incoming Sidebar Chat Request for {{store}}",chat_request_storefront:"Incoming Storefront Chat Request for {{name}}",toast_message_brand:"Incoming Chat Request for {{brand}}",toast_message_neutral:"Incoming Chat Request for {{store}}",toast_message_sidebar:"Incoming Sidebar Chat Request for {{store}}",toast_message_storefront:"Incoming Storefront Chat Request for {{name}}",toast_message_top3:"You are in the top 3 of the Live Chat queue. Are you still available?",toast_message_broadcast_heartbeat:"You are eligible to receive Live Chat requests. Are you still available?",toast_message_next:"You are up next, and will receive the next Chat soon. Do you want to remain in the queue?",toast_message_missed:"You missed a Chat request. Are you still available?",toast_message_checking:"Just checking in, are you still available for Live Chat?",toast_message_inactive:"You did not confirm your availability for Live Chat and have been removed. Do you want to re-join?",chat_flag_confirmation:"Are you sure you want to flag this conversation? \nThe other party will be warned and the session will be disconnected",customer_chat_flagged:"You've been Flagged and reported",customer_chat_flagged_descriptive:"This conversation was flagged for review and the session has been disconnected.",chat_welcome_message_sidebar:"Hi, my name is {{user}}, how can I help you?",chat_welcome_message_storefront:"Hi, this is {{user}}, how can I help you?",chat_to_cs_rep:"This conversation was transfered to Customer Service and the session has been disconnected.",chat_to_cs_customer:"In order to better handle this request, I am transferring you to our Customer Support chat. You will be connected momentarily.",chat_to_cs_confirm:"Are you sure you want to transfer this conversation to Customer Service? The customer will be notified and the session will be disconnected.",chat_connect_message_rep:"Give me a moment to connect you with {{user}} at the {{store}} location.",chat_connect_message_store:"Give me a moment to connect you with a store associate at the {{store}} location.",chat_connect_message_rep_step_2:"The store must be busy. Don't worry, {{user}} should be with you in the next minute.",chat_connect_message_store_step_2:"The store must be busy. Don't worry, a store associate should be with you in the next minute.",chat_connect_message_rep_step_3:"Still trying to connect you... however, <strong>if you don't want to wait</strong>, send a message and {{user}} will reply shortly.",chat_connect_message_store_step_3:"Still trying to connect you... however, <strong>if you don't want to wait</strong>, send a message and someone will reply shortly."}},en_IE:{translation:{dropdown_all_specialties:"All Specialties",dropdown_any_specialties:"Any Specialties",categories_and:" and ",categories_other:" and other specialties",customer_email_validation:"Please enter a valid email",virtual_store_ambassador:"Ambassador - {{name}}",user_type_customer:"Customer",button_connect:"CONNECT",button_leave_message:"LEAVE A MESSAGE",and:"and",carousel_located:"are located in",carousel_rep_text:"{{name}} is available now.",chat_quit_active:"You are about to leave an active chat session.",chat_message_sent:"Sent. Not seen yet.",chat_missed_request:"You missed a chat request, you are now offline.",chat_session_disconnected:"The chat session has been disconnected",chat_customer_idle:"Your Customer is idle",chat_customer_left:"Your Customer has left the chat",chat_customer_active:"The Customer is no longer idle",chat_customer_disconnected:"Your Customer got disconnected",chat_request_neutral:"Incoming Chat Request for {{store}}",chat_request_sidebar:"Incoming Sidebar Chat Request for {{store}}",chat_request_storefront:"Incoming Storefront Chat Request for {{name}}",toast_message_brand:"Incoming Chat Request for {{brand}}",toast_message_neutral:"Incoming Chat Request for {{store}}",toast_message_sidebar:"Incoming Sidebar Chat Request for {{store}}",toast_message_storefront:"Incoming Storefront Chat Request for {{name}}",toast_message_top3:"You are in the top 3 of the Live Chat queue. Are you still available?",toast_message_broadcast_heartbeat:"You are eligible to receive Live Chat requests. Are you still available?",toast_message_next:"You are up next, and will receive the next Chat soon. Do you want to remain in the queue?",toast_message_missed:"You missed a Chat request. Are you still available?",toast_message_checking:"Just checking in, are you still available for Live Chat?",toast_message_inactive:"You did not confirm your availability for Live Chat and have been removed. Do you want to re-join?",chat_flag_confirmation:"Are you sure you want to flag this conversation? \nThe other party will be warned and the session will be disconnected",customer_chat_flagged:"You've been Flagged and reported",customer_chat_flagged_descriptive:"This conversation was flagged for review and the session has been disconnected.",chat_welcome_message_sidebar:"Hi, my name is {{user}}, how can I help you?",chat_welcome_message_storefront:"Hi, this is {{user}}, how can I help you?",chat_to_cs_rep:"This conversation was transfered to Customer Service and the session has been disconnected.",chat_to_cs_customer:"In order to better handle this request, I am transferring you to our Customer Support chat. You will be connected momentarily.",chat_to_cs_confirm:"Are you sure you want to transfer this conversation to Customer Service? The customer will be notified and the session will be disconnected.",chat_connect_message_rep:"Give me a moment to connect you with {{user}} at the {{store}} location.",chat_connect_message_store:"Give me a moment to connect you with a Store Associate at the {{store}} location.",chat_connect_message_rep_step_2:"The store must be busy. Don't worry, {{user}} should be with you in the next minute.",chat_connect_message_store_step_2:"The store must be busy. Don't worry, a Store Associate should be with you in the next minute.",chat_connect_message_rep_step_3:"Still trying to connect you... however, <strong>if you don't want to wait</strong>, send a message and {{user}} will reply shortly.",chat_connect_message_store_step_3:"Still trying to connect you... however, <strong>if you don't want to wait</strong>, send a message and someone will reply shortly."}},fr_CA:{translation:{dropdown_all_specialties:"Toutes les Spécialités",dropdown_any_specialties:"Toutes les Spécialités",categories_and:" et ",categories_other:" et autres spécialités",customer_email_validation:"Veuillez entrer une adresse courriel valide",virtual_store_ambassador:"Ambassadeur - {{name}}",user_type_customer:"Client",button_connect:"SE CONNECTER",button_leave_message:"LAISSER UN MESSAGE",and:"et",carousel_located:"sont situés à",carousel_rep_text:"{{name}} est disponible.",chat_quit_active:"Vous êtes sur le point de quitter une session de clavardage active.",chat_message_sent:"Envoyé. Non lu.",chat_missed_request:"Vous avez manqué une demande de clavardage, vous êtes maintenant hors ligne.",chat_session_disconnected:"La séance de clavardage a été déconnectée.",chat_customer_idle:"Votre client est inactif",chat_customer_left:"Votre client a quitté le clavardage",chat_customer_active:"Le client est actif à nouveau",chat_customer_disconnected:"Votre client a été déconnecté",chat_request_neutral:"Demande de clavardage entrante pour {{store}}",chat_request_sidebar:"Demande de clavardage entrante pour {{store}}",chat_request_storefront:"Demande de clavardage entrante pour {{name}}",toast_message_brand:"Demande de clavardage entrante pour {{brand}}",toast_message_neutral:"Demande de clavardage entrante pour {{store}}",toast_message_sidebar:"Demande de clavardage entrante pour {{store}}",toast_message_storefront:"Demande de clavardage entrante pour {{name}}",toast_message_top3:"Vous êtes dans le top 3 de la file d'attente de clavardage. Êtes-vous toujours disponible?",toast_message_broadcast_heartbeat:"Vous êtes éligible à recevoir les demandes de clavardage. Êtes-vous toujours disponible?",toast_message_next:"Vous êtes le suivant, et receverez une demande de clavardage prochainement. Voulez-vous rester en file?",toast_message_missed:"Vous avez manqué une demande de clavardage. Êtes-vous toujours disponible?",toast_message_checking:"Êtes-vous toujours disponible pour clavarder?",toast_message_inactive:"Vous avez manqué une demande de clavardage. Êtes-vous toujours disponible?",chat_flag_confirmation:"Êtes-vous certain de vouloir signaler cette conversation? \nL’autre partie sera avertie et la session sera déconnectée",customer_chat_flagged:"Vous avez été signalé",customer_chat_flagged_descriptive:"Cette conversation a été signalée à des fins d'examen et la séance a été interrompue.",chat_welcome_message_sidebar:"Bonjour, mon nom est {{user}}, comment puis-je vous aider?",chat_welcome_message_storefront:"Bonjour, ici {{user}}, comment puis-je vous aider?",chat_to_cs_rep:"Cette conversation a été transférée au service clientèle et la session a été déconnectée.",chat_to_cs_customer:"Afin de mieux gérer cette demande, je vous transfère vers notre chat de support client. Vous serez connecté momentanément.",chat_to_cs_confirm:"Êtes-vous sûr de vouloir transférer cette conversation au service client? Le client sera averti et la session sera déconnectée.",chat_connect_message_rep:"Donnez-moi un instant pour vous connecter à {{user}} à l'emplacement {{store}}.",chat_connect_message_store:"Donnez-moi un instant pour vous mettre en contact avec un associé en magasin à l'emplacement {{store}}",chat_connect_message_rep_step_2:"Le magasin doit être occupé. Ne vous inquiétez pas, {{user}} devrait être avec vous dans la prochaine minute.",chat_connect_message_store_step_2:"Le magasin doit être occupé. Ne vous inquiétez pas, un associé en magasin devrait être avec vous dans la prochaine minute.",chat_connect_message_rep_step_3:"Nous essayons toujours de vous connecter ... Cependant, <strong>si vous ne voulez pas attendre</strong>, envoyez un message et {{user}} vous répondra sous peu.",chat_connect_message_store_step_3:"Nous essayons toujours de vous connecter ... Cependant, <strong>si vous ne voulez pas attendre</strong>, envoyez un message et quelqu'un vous répondra sous peu."}}}},function(err,t){})},initVars:function(){this.sfVars=$("#sf-vars");this.currentUser=this.getVar("user");this.currentEnv=this.getVar("env");this.currentRetailer=this.getVar("retailer");this.prettyName=this.getVar("pretty-name");this.currentStoreId=this.getVar("store-id");this.currentStoreIdentifier=this.getVar("store-identifier");this.currentStoreName=this.getVar("store-name");this.currentType=this.getVar("type");this.currentMode=this.getVar("mode");this.saleCookieExpire=this.getVar("salecookie");this.attachedServices=this.getVar("attached");this.admin=this.getVar("admin");this.repName=this.getVar("repname");this.webHost=this.getVar("storefront");this.cookiePrefix=this.getVar("cookieprefix");this.virtualStore=this.getVar("virtual-store");this.virtualStoreId=this.getVar("virtual-store-id");this.api=this.getVar("api");this.employeeId=this.getVar("employee-id");this.findrepName=this.getVar("findrep-name");this.firstName=this.getVar("first-name");this.isQueueActive=this.getVar("is-queue-active");this.isMultibrand=this.getVar("is-multibrand");this.otherBrand=this.getVar("other-brand");this.otherBrandHost=this.getVar("other-brand-host");this.firebaseInstance=this.getVar("firebase-url");this.chatDelay=this.getVar("chat-delay");this.context=this.getVar("from");this.embed=this.getVar("embed");this.selectSpecialty=this.getVar("select-specialty");this.repsHaveSpecialty=this.getVar("reps-have-specialty");this.sidebarTrackingEnabled=this.sidebar2TrackingEnabled||this.getVar("sidebar-tracking-enabled");if(this.currentType==="rep"){this.virtualStore=""}},enableAndAddToQueue:function(){return this.ChatManager.enableAndAddToQueue(this.currentStoreIdentifier,this.currentUser)},disableAndRemoveFromQueue:function(){this.ChatManager.disableAndRemoveFromQueue(this.currentStoreIdentifier,this.currentUser)},initFirebase:function(){if(this.currentEnv==="travis"){this.currentEnv="int"}this.firebaseBaseUrl=this.firebaseInstance+this.currentEnv+"/"+this.currentRetailer;this.basePresenceUrl=this.firebaseBaseUrl+"/presence"},initSecurity:function(){var self=this;if(this.admin){addBearerHeader(Cookies.get(self.cookiePrefix+"SF-TOKEN"));$.ajaxPrefilter(function(opts,originalOpts,jqXHR){if(opts.refreshRequest){return}var dfd=$.Deferred();jqXHR.done(dfd.resolve);jqXHR.fail(function(){var args=Array.prototype.slice.call(arguments);if(jqXHR.status===401){$.ajax({type:"GET",crossDomain:true,url:self.api+"/refresh",refreshRequest:true}).done(function(data,textStatus,jqxhr){var responseText=JSON.parse(jqxhr.responseText);if(responseText.data&&responseText.data.token){var newToken=responseText.data.token;addBearerHeader(newToken);var newOpts=$.extend({},originalOpts,{refreshRequest:true});$.ajax(newOpts).then(dfd.resolve,dfd.reject)}else{dfd.rejectWith(jqXHR,args)}}).fail(function(jqxhr,textStatus,errorThrow){dfd.rejectWith(jqXHR,args)})}else{dfd.rejectWith(jqXHR,args)}});return dfd.promise(jqXHR)})}function addBearerHeader(token){if(token&&typeof token!=="undefined"){$.ajaxSetup({headers:{Authorization:"Bearer "+token}})}}},getVar:function(id){return this.sfVars.data(id)},handleMessage:function(event){var data;if(event&&event.data&&event.data!=="sf_handshake"){try{data=JSON.parse(event.data)}catch(e){return false}}if(!data||data==="sf_handshake"){this.parent=event.source;this.origin=event.origin;BaseView.prototype.parent=this.parent;BaseView.prototype.origin=this.origin;this.afterHandshake&&this.afterHandshake()}else if(data.args){this[data.action]&&this[data.action].apply(this,data.args)}else if(this[data.action]){this[data.action]&&this[data.action].call(this,data)}else if(typeof data.allowBubbling!=="undefined"&&data.allowBubbling){this.parent&&this.parent.postMessage(event.data,this.origin)}},handleError:function(message){var data=JSON.stringify({action:"hide",widget:this.name});this.parent&&this.parent.postMessage(data,this.origin)},addSource:function(data){this.source_url=data.source_url;this.source_title=data.source_title},logEvent:function(id,eventType,isStore,successCb){var sfid=$("#sf-vars").data("sfid");var args={type:eventType,uniq_id:sfid,customer_id:"0",attributes:"",satisfied:"0",event_id:"0"};if(isStore){args.store_id=id}else{args.user_id=id}var options={method:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify(args),dataType:"json",processData:false,success:function(){var self=this;if(successCb){successCb()}}};$.ajax(this.api+"/events",options)},pushEventQueue:function(actionEvent,actionId){if(typeof sf_widget!=="undefined"&&sf_widget){sf_widget.utils.eventQueue.push(actionEvent,actionId);return}this.parent&&this.parent.postMessage(JSON.stringify({utils:"eventQueue",action:"pushByPostMessage",allowBubbling:true,actionEvent:actionEvent,actionId:actionId}),this.origin)},pushViewEvent:function(actionEvent,actionId){if(typeof sf_widget!=="undefined"&&sf_widget){sf_widget.utils.eventQueue.pushViewEvent(actionEvent,actionId);return}this.parent&&this.parent.postMessage(JSON.stringify({utils:"eventQueue",action:"pushViewEventByPostMessage",allowBubbling:true,actionEvent:actionEvent,actionId:actionId}),this.origin)},checkEventQueueFingerprint:function(){if(typeof sf_widget!=="undefined"&&sf_widget){sf_widget.utils.eventQueue.checkFingerprint();return}this.parent&&this.parent.postMessage(JSON.stringify({utils:"eventQueue",action:"checkFingerprintByPostMessage",allowBubbling:true}),this.origin)},openService:function(e,openUrl){e&&e.preventDefault();var self=this;var $target=$(e.currentTarget);var serviceName=$target.data("name");var width=$target.data("width")||"386px";var height=$target.data("height")||"888px";var leftPos=parseInt($(window).width()/2-360,10);if($target.is(".is-disabled, .js-chat-is-disabled, .sf-is-disabled, .sidebar-action--is-disabled, .js-sidebar-disabled")){if(serviceName!=="sidebar3-chat"){width="386px";height="888px"}var serviceUrl=$(".sf-fn-question-trigger").length>0?$(".sf-fn-question-trigger").data("serviceurl"):$target.data("serviceurl-fallback");openUrl=serviceUrl+"&chat=true"}var url=openUrl||$target.data("serviceurl");if(this.chatFrom!=="landing"&&typeof gtag!=="undefined"){gtag("event","click",{event_category:"sidebar_click",event_label:"sidebar3 was clicked"})}if(window.screen.height<=900){height=window.screen.height-120}if(this.getVar("sf-locale").length>0){url+=url.indexOf("&sf_locale="+encodeURIComponent(this.getVar("sf-locale")))!==-1?"":"&sf_locale="+encodeURIComponent(this.getVar("sf-locale"))}var sourceTitle=this.source_title||$("#sf-vars").data("source-title");var sourceUrl=this.source_url||$("#sf-vars").data("source-url");if(sourceTitle&&sourceUrl){url+="&source_title="+encodeURIComponent(sourceTitle)+"&source_url="+encodeURIComponent(sourceUrl)}var isChatSidebar=$target.hasClass("sidebar-action-chat")&&!$target.hasClass("sidebar-action--is-disabled");var isChatFooter=$target.hasClass("sf-chat-button")&&!$target.hasClass("sf-is-disabled");if(typeof window.orientation!=="undefined"&&this.chatVersion===2||typeof window.orientation!=="undefined"&&(!isChatFooter&&!isChatSidebar)){if(this.embed&&this.embed==="landing"){this.handleServiceLink(e,url)}else{var data=JSON.stringify({action:"changeLocation",widget:this.name,url:url});this.parent&&this.parent.postMessage(data,this.origin)}if(this.sidebarTrackingEnabled){this.parent&&this.parent.postMessage(JSON.stringify({action:"dispatchSidebarMobileClickTrackingEvent",eventName:"SIDEBAR_MOBILE_CLICK"}),this.origin)}}else{if(this.version===2){window.location.assign(url)}else if(this.chatFrom==="landing"){this.handleServiceLink(e,url)}else{if(this.popup&&!this.popup.closed){window.open("","sf_window");this.popup.focus();this.popup.postMessage("sf_handshake","*")}else{this.parent&&this.parent.postMessage(JSON.stringify({action:"dispatchSalesfloorEvent",eventName:"sidebar_clicked"}),this.origin);if(this.sidebarTrackingEnabled){this.parent&&this.parent.postMessage(JSON.stringify({action:"dispatchSidebarTrackingEvent",eventName:"sidebar_desktop_clicked"}),this.origin)}this.popup=window.open(url,"sf_window","height="+height+", width="+width+", top=0, left="+leftPos+"px, location=no, toolbar=no, scrollbars=yes, resizable=yes");if(this.sfVars.data("sidebar-v3-mode")){this.popupHandShake=setInterval(function(){if(self.popup.postMessage){self.popup.postMessage("sf_handshake","*")}},200)}}}}},stopIntervalCheck:function(){window.clearInterval(this.popupHandShake)},getCookie:function(cname){sf_widget.utils.dataStorage.get(cname)},setCookie:function(cname,cvalue,exdays){sf_widget.utils.dataStorage.set({name:cname,value:cvalue,expires:exdays})},removeCookie:function(cookie){this.setCookie(cookie)},initUserRef:function(){if(this.currentType==="store"){this.userRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier)}else{this.userRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier+"/"+this.currentUser)}},connectPresence:function(){this.initUserRef();this.setPresenceListener()},setPresenceListener:function(){this.listenTo(this.userRef,"value",this.onUserValue);this.setRequestListener();this.ambassadorRef=this.getAmbassadorRef();if(!this.ambassadorRef){return}this.listenTo(this.ambassadorRef,"value",this.onAmbassadorValue)},setRequestListener:function(){if(this.currentType==="store"){this.hasActiveRequestRef=new Firebase(this.firebaseBaseUrl+"/request/stores/"+this.currentUser)}else{this.hasActiveRequestRef=new Firebase(this.firebaseBaseUrl+"/request/reps/"+this.currentUser)}this.listenTo(this.hasActiveRequestRef,"value",this.onRequestValue)},onRequestValue:function(snapshot){var self=this;this.userRef.once("value",function(repsSnapshot){self.getAmbassadorPromise().then(function(ambassadorPresence){var presence=self.sanitizeEnabled(repsSnapshot.val())||self.sanitizeEnabled(ambassadorPresence),hasActiveRequest=!!snapshot.val(),enabled=!hasActiveRequest&&presence;self.setPresenceUI(enabled)})})},sanitizeEnabled:function(enabled){if(enabled===null||enabled==="missed"||enabled==="heartbeatMissed"){return false}else if(enabled===true){return true}else if(this.isEnableObject(enabled)){return true}else if(this.isPresenceList(enabled)){return this.sanitizePresenceList(enabled)}else{return false}},sanitizePresenceList:function(enabled){var isAvailable=false;if(this.isPresenceList(enabled)){var rep;for(rep in enabled){if(enabled.hasOwnProperty(rep)){isAvailable=this.sanitizeEnabled(enabled[rep]);if(isAvailable){break}}}}return isAvailable},onUserValue:function(snapshot){var promise=this.getAmbassadorPromise();this.onPresenceValue(promise,snapshot.val())},onAmbassadorValue:function(snapshot){var promise=this.getRepPromise();this.onPresenceValue(promise,snapshot.val())},onPresenceValue:function(promise,enabledRef1){var self=this;promise.then(function(enabledRef2){enabledRef1=self.sanitizeEnabled(enabledRef1);enabledRef2=self.sanitizeEnabled(enabledRef2);self.setUserStatus(enabledRef1,enabledRef2)})},setUserStatus:function(repEnabled,ambassadorsEnabled){var enabled=repEnabled||ambassadorsEnabled,self=this;this.hasActiveRequestRef.once("value",function(snapshot){enabled=snapshot.val()===null&&enabled;self.setPresenceUI(enabled)})},setPresenceUI:function(){},isEnableObject:function(enabled){return typeof enabled==="object"&&enabled.hasOwnProperty("timestamp")},isPresenceList:function(enabled){return enabled!==null&&typeof enabled==="object"&&Object.keys(enabled).length>0},getType:function(type){return is_store===true?"store":"rep"},getAmbassadorRef:function(){if(!this.virtualStore||this.virtualStore.length===0){return false}return new Firebase(this.basePresenceUrl+"/"+this.virtualStore)},getRefPromise:function(ref){if(!ref||!ref.once){return}var deferred=$.Deferred();ref.once("value",function(snapshot){deferred.resolve(snapshot.val())});return deferred.promise()},getAmbassadorPromise:function(){var ambassadorRef=this.ambassadorRef||this.getAmbassadorRef();if(!ambassadorRef){return this.getEmptyPromise()}return this.getRefPromise(ambassadorRef)},getRepPromise:function(){return this.getRefPromise(this.userRef)},getEmptyPromise:function(){var deferred=$.Deferred();deferred.resolve({});return deferred.promise()},pushNotification:function(reps,message,inapp){inapp=inapp||false;var options={method:"POST",contentType:"application/json;charset=UTF-8",data:JSON.stringify({reps:reps,message:message,inapp:inapp}),dataType:"json",processData:false};$.ajax(this.webHost+"/api/pushNotification/firebase/publish",options)},trackChatActivity:function(args){try{$.ajax({type:"POST",url:this.api+"/customer-activity-feed/track-activity",data:JSON.stringify(args),cache:false,contentType:"application/json;charset=UTF-8",dataType:"json"})}catch(e){return false}},logFlaggedChat:function(args){return $.ajax({type:"POST",url:this.api+"/chat/flag",data:JSON.stringify(args),cache:false,contentType:"application/json;charset=UTF-8",dataType:"json"})},updateFlaggedChatData:function(args){$.ajax({type:"PUT",url:this.api+"/chat/flag",data:JSON.stringify(args),cache:false,contentType:"application/json;charset=UTF-8",dataType:"json"})},getConnectedReps:function(callback,args,type){var self=this;var func=this.applyRepTypeMap(type);this[func].call(this,callback,args)},applyRepTypeMap:function(type){var typeMap={reps:"getRepsOnly",virtuals:"getVirtualsOnly",all:"getAllReps"};return typeMap[type]||typeMap.reps},getAllReps:function(callback,args,snapshot){var self=this;this.storePresenceRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier);this.storePresenceRef.once("value",function(snapshot){self.getAmbassadorPromise().then(function(ambassadors){args=args||[];var reps=_.extend({},snapshot.val(),ambassadors);reps=self.filterConnectedReps(reps);callback.apply(self,[reps].concat(args))})})},getRepsOnly:function(callback,args,snapshot){var self=this;this.storePresenceRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier);this.storePresenceRef.once("value",function(snapshot){args=args||[];var reps=self.filterConnectedReps(snapshot.val());callback.apply(self,[reps].concat(args))})},getVirtualsOnly:function(callback,args,snapshot){var self=this;this.virtualsPresenceRef=new Firebase(this.basePresenceUrl+"/"+this.virtualStore);this.virtualsPresenceRef.once("value",function(snapshot){args=args||[];var reps=self.filterConnectedReps(snapshot.val());callback.apply(self,[reps].concat(args))})},filterConnectedReps:function(reps){var filtered={};_.reduce(reps,function(filtered,status,rep){if(status===true||typeof status==="object"||status==="unavailable"){filtered[rep]=status}return filtered},filtered);return filtered},pushExcludeRep:function(excludedRep,reps,message,inapp){var user_login=excludedRep.user_login?excludedRep.user_login:excludedRep;if(reps){delete reps[user_login]}this.pushNotification(reps,message,inapp)},getCurrentFirebaseStamp:function(){var timestamp=new Firebase(this.firebaseInstance+"timestamp");timestamp.set(Firebase.ServerValue.TIMESTAMP);var stamp;timestamp.once("value",function(snapshot){stamp=snapshot.val();timestamp.remove()});return stamp},switchUserStatus:function(rep,status,ref){ref=ref||new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier+"/"+rep);if(status==="remove"){ref.remove()}else{ref.set(status)}},switchRepStatus:function(rep,status){var repPresenceRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier+"/"+rep);this.switchUserStatus(rep,status,repPresenceRef)},switchVirtualStatus:function(rep,status){var virtualsPresenceRef=new Firebase(this.basePresenceUrl+"/"+this.virtualStore+"/"+rep);this.switchUserStatus(rep,status,virtualsPresenceRef)},applyWithCurrentStatus:function(fun,args){var self=this;this.userPresenceRef=new Firebase(this.basePresenceUrl+"/"+this.currentStoreIdentifier+"/"+this.currentUser);this.userPresenceRef.once("value",function(snapshot){fun.apply(self,[snapshot.val()].concat(args))})},buildRepObject:function(status){var rep={};rep[this.currentUser]=status;return rep},sendLoopToCurrentRepIfAvailable:function(status,message,inapp,params){var rep=this.buildRepObject(status);params=params||this.getLoopParams();if(!this.sanitizeEnabled(status)){return false}params.target="reps";this.sendLoopNotification(rep,message,inapp,params)},getLoopParams:function(){return{delay:3e4,count:this.getLoopCountParam(),need_reps_available:true}},getLoopCountParam:function(){if(this.isQueueActive){return 3}return 1},sendLoopNotification:function(reps,messages,inapp,loopParams){this.repsSpecialists=reps;var sendNotification=_.bind(function(repsSpecialists){this.pushNotification(repsSpecialists,messages.init,inapp);var looped=1,self=this,repRequest;if(loopParams.target==="reps"){repRequest=Object.keys(reps)[0]}var loopNotification=function(repsUpdated){if(repRequest){var status=repRequest in repsUpdated;reps=self.buildRepObject(status)}else{reps=repsUpdated||repsSpecialists}var loopFn=function(reps,execute){if(execute===false){++looped;if(!reps){self.resetChatQueueLoopInterval(loopParams.delay);self.intervalCallback()}return}var count=(loopParams.count*loopParams.delay-looped*loopParams.delay)/1e3;if(++looped>=loopParams.count){clearInterval(this.loopNotificationInterval);if(looped>loopParams.count){return}}var message=messages.loop.replace("%%count%%",count);self.pushNotification(reps,message,inapp)};if(loopParams.filter){loopParams.filter(reps,loopFn,looped)}else{loopFn(reps)}};var target=loopParams.target||"all";if(loopParams.need_reps_available){this.intervalCallback=this.getConnectedReps.bind(this,loopNotification,[],target)}else{this.intervalCallback=loopNotification}this.loopNotificationInterval=setInterval(this.intervalCallback,loopParams.delay)},this);if(this.isQueueActive&&_.isUndefined(this.declinedListenerReady)){this.initUserRef();this.userRef.on("value",_.bind(this.handleRepDeclined,this,loopParams));this.declinedListenerReady=true}if(loopParams.filter){loopParams.filter(reps,sendNotification,0)}else{sendNotification(this.repsSpecialists)}},handleRepDeclined:function(loopParams,snapshot){if(_.isUndefined(this.repsSpecialists)){return}var repsNotified=this.repsSpecialists;this.previouslyDeclined=this.previouslyDeclined||[];var repPresence=snapshot.val();var that=this;var declined=_.reduce(_.pairs(repPresence),function(memo,rep){var repName=rep[0];var repStatus=rep[1];if(repStatus==="declined"&&_.has(repsNotified,repName)&&!_.contains(that.previouslyDeclined,repName)){memo.push(repName);that.previouslyDeclined.push(repName)}return memo},[]);if(declined.length>0){this.resetChatQueueLoopInterval(loopParams.delay);this.intervalCallback()}},resetChatQueueLoopInterval:function(delay){clearInterval(this.loopNotificationInterval);this.loopNotificationInterval=setInterval(this.intervalCallback,delay)},isStore:function(){return this.currentType==="store"},getCurrentId:function(){if(this.isStore()){return this.currentStoreId}return this.currentUser},applyBeforePredicate:function(predicate,f){var self=this;return function(){return predicate.apply(self,arguments)&&f.apply(self,arguments)}},wrapReturn:function(f){return function(returnValue){return f(returnValue)||returnValue}}});_.extend(Backbone.Validation.patterns,{email:/^(?!\.)((?!.*\.{2})[a-zA-Z0-9\+\u0080-\u00FF\u0100-\u017F\u0180-\u024F\u0250-\u02AF\u0300-\u036F\u0370-\u03FF\u0400-\u04FF\u0500-\u052F\u0530-\u058F\u0590-\u05FF\u0600-\u06FF\u0700-\u074F\u0750-\u077F\u0780-\u07BF\u07C0-\u07FF\u0900-\u097F\u0980-\u09FF\u0A00-\u0A7F\u0A80-\u0AFF\u0B00-\u0B7F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0D00-\u0D7F\u0D80-\u0DFF\u0E00-\u0E7F\u0E80-\u0EFF\u0F00-\u0FFF\u1000-\u109F\u10A0-\u10FF\u1100-\u11FF\u1200-\u137F\u1380-\u139F\u13A0-\u13FF\u1400-\u167F\u1680-\u169F\u16A0-\u16FF\u1700-\u171F\u1720-\u173F\u1740-\u175F\u1760-\u177F\u1780-\u17FF\u1800-\u18AF\u1900-\u194F\u1950-\u197F\u1980-\u19DF\u19E0-\u19FF\u1A00-\u1A1F\u1B00-\u1B7F\u1D00-\u1D7F\u1D80-\u1DBF\u1DC0-\u1DFF\u1E00-\u1EFF\u1F00-\u1FFF\u20D0-\u20FF\u2100-\u214F\u2C00-\u2C5F\u2C60-\u2C7F\u2C80-\u2CFF\u2D00-\u2D2F\u2D30-\u2D7F\u2D80-\u2DDF\u2F00-\u2FDF\u2FF0-\u2FFF\u3040-\u309F\u30A0-\u30FF\u3100-\u312F\u3130-\u318F\u3190-\u319F\u31C0-\u31EF\u31F0-\u31FF\u3200-\u32FF\u3300-\u33FF\u3400-\u4DBF\u4DC0-\u4DFF\u4E00-\u9FFF\uA000-\uA48F\uA490-\uA4CF\uA700-\uA71F\uA800-\uA82F\uA840-\uA87F\uAC00-\uD7AF\uF900-\uFAFF\.!#$%&'*+-/=?^_`{|}~\-\d]+)@(?!\.)([a-zA-Z0-9\u0080-\u00FF\u0100-\u017F\u0180-\u024F\u0250-\u02AF\u0300-\u036F\u0370-\u03FF\u0400-\u04FF\u0500-\u052F\u0530-\u058F\u0590-\u05FF\u0600-\u06FF\u0700-\u074F\u0750-\u077F\u0780-\u07BF\u07C0-\u07FF\u0900-\u097F\u0980-\u09FF\u0A00-\u0A7F\u0A80-\u0AFF\u0B00-\u0B7F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0D00-\u0D7F\u0D80-\u0DFF\u0E00-\u0E7F\u0E80-\u0EFF\u0F00-\u0FFF\u1000-\u109F\u10A0-\u10FF\u1100-\u11FF\u1200-\u137F\u1380-\u139F\u13A0-\u13FF\u1400-\u167F\u1680-\u169F\u16A0-\u16FF\u1700-\u171F\u1720-\u173F\u1740-\u175F\u1760-\u177F\u1780-\u17FF\u1800-\u18AF\u1900-\u194F\u1950-\u197F\u1980-\u19DF\u19E0-\u19FF\u1A00-\u1A1F\u1B00-\u1B7F\u1D00-\u1D7F\u1D80-\u1DBF\u1DC0-\u1DFF\u1E00-\u1EFF\u1F00-\u1FFF\u20D0-\u20FF\u2100-\u214F\u2C00-\u2C5F\u2C60-\u2C7F\u2C80-\u2CFF\u2D00-\u2D2F\u2D30-\u2D7F\u2D80-\u2DDF\u2F00-\u2FDF\u2FF0-\u2FFF\u3040-\u309F\u30A0-\u30FF\u3100-\u312F\u3130-\u318F\u3190-\u319F\u31C0-\u31EF\u31F0-\u31FF\u3200-\u32FF\u3300-\u33FF\u3400-\u4DBF\u4DC0-\u4DFF\u4E00-\u9FFF\uA000-\uA48F\uA490-\uA4CF\uA700-\uA71F\uA800-\uA82F\uA840-\uA87F\uAC00-\uD7AF\uF900-\uFAFF\-\.\d]+)((\.([a-zA-Z\u0080-\u00FF\u0100-\u017F\u0180-\u024F\u0250-\u02AF\u0300-\u036F\u0370-\u03FF\u0400-\u04FF\u0500-\u052F\u0530-\u058F\u0590-\u05FF\u0600-\u06FF\u0700-\u074F\u0750-\u077F\u0780-\u07BF\u07C0-\u07FF\u0900-\u097F\u0980-\u09FF\u0A00-\u0A7F\u0A80-\u0AFF\u0B00-\u0B7F\u0B80-\u0BFF\u0C00-\u0C7F\u0C80-\u0CFF\u0D00-\u0D7F\u0D80-\u0DFF\u0E00-\u0E7F\u0E80-\u0EFF\u0F00-\u0FFF\u1000-\u109F\u10A0-\u10FF\u1100-\u11FF\u1200-\u137F\u1380-\u139F\u13A0-\u13FF\u1400-\u167F\u1680-\u169F\u16A0-\u16FF\u1700-\u171F\u1720-\u173F\u1740-\u175F\u1760-\u177F\u1780-\u17FF\u1800-\u18AF\u1900-\u194F\u1950-\u197F\u1980-\u19DF\u19E0-\u19FF\u1A00-\u1A1F\u1B00-\u1B7F\u1D00-\u1D7F\u1D80-\u1DBF\u1DC0-\u1DFF\u1E00-\u1EFF\u1F00-\u1FFF\u20D0-\u20FF\u2100-\u214F\u2C00-\u2C5F\u2C60-\u2C7F\u2C80-\u2CFF\u2D00-\u2D2F\u2D30-\u2D7F\u2D80-\u2DDF\u2F00-\u2FDF\u2FF0-\u2FFF\u3040-\u309F\u30A0-\u30FF\u3100-\u312F\u3130-\u318F\u3190-\u319F\u31C0-\u31EF\u31F0-\u31FF\u3200-\u32FF\u3300-\u33FF\u3400-\u4DBF\u4DC0-\u4DFF\u4E00-\u9FFF\uA000-\uA48F\uA490-\uA4CF\uA700-\uA71F\uA800-\uA82F\uA840-\uA87F\uAC00-\uD7AF\uF900-\uFAFF]){2,63})+)$/i});var CookieView=BaseView.extend({name:"cookie",initialize:function(){var self=this;this.constructor.__super__.initialize.apply(this)},afterHandshake:function(){this.sendCookie()},sendCookie:function(){if(/MSIE/.test(navigator.userAgent)||!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)){var self=this;$.getJSON("/cookies/manager/cookies",function(jsonCookies){var cookies=decodeURIComponent($.param(jsonCookies).replace(/&/g,";"));self.setMessage(cookies);for(var key in jsonCookies){if(jsonCookies.hasOwnProperty(key)){if(/customer_id/.test(key)){self.handleIEClaimLead(jsonCookies[key])}}}});$.getJSON("/cookies/manager/vars",function(jsonVars){var affiliateURL=jsonVars.affiliateurl;var repID=jsonVars.replogin;self.postAffiliateData(affiliateURL,repID);self.postAdditionalTrackingData(jsonVars)})}else{var jsonCookies=$("#sf-cookies").data();var cookies=decodeURIComponent($.param(jsonCookies).replace(/&/g,";"));this.setMessage(cookies);this.handleClaimedLead()}},setMessage:function(cookies){var data=JSON.stringify({action:"sendCookie",widget:"cookie",cookies:cookies});this.parent&&this.parent.postMessage(data,this.origin)},alerts:function(){$.getJSON("/cookies/manager/cookies",function(data){var cookies=decodeURIComponent($.param(data).replace(/&/g,";"));alert(cookies)})},handleClaimedLead:function(){var affiliateURL,repID,employeeID,employeeName,self=this;this.retailer=$("#sf-vars").data("retailer");affiliateURL=$("#sf-vars").data("affiliateurl"),repID=$("#sf-vars").data("replogin");var data=$("#sf-vars").data();this.postAffiliateData(affiliateURL,repID);this.postAdditionalTrackingData(data)},handleIEClaimLead:function(customer_id){var self=this;if(customer_id){$.getJSON("/rep/for/"+customer_id,function(data){if(data&&data.user_login){affiliateURL=data.affiliateURL;repID=data.user_login;var postData={retailer:"salesfloor",employeeID:data.employee_id,employeeName:data.display_name,repLogin:data.user_login,storeId:data.store};self.postAffiliateData(affiliateURL,repID);self.postAdditionalTrackingData(postData)}})}},postAffiliateData:function(affiliateURL,repID){if(affiliateURL||repID){var data=JSON.stringify({action:"setImgAffiliate",widget:"cookie",affiliateURL:affiliateURL,repId:repID});this.parent&&this.parent.postMessage(data,this.origin)}},postAdditionalTrackingData:function(postData){var data=JSON.stringify({action:"setAdditionalTrackingCookies",widget:"cookie",data:postData});this.parent&&this.parent.postMessage(data,this.origin)}});var myCookieView=new CookieView;