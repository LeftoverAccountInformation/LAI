!function(){function e(){this.parentOrigin=void 0,this.messageHandlers={},this.featureScripts={},this.sessionLoaded=!1,this.pendingMessages={},this.availableFeatures=["script"],window.location.search.replace(/([a-zA-Z0-9]+)=([\S]+)/g,function(e,s,t){"parent"===s&&(this.parentOrigin=t)}.bind(this)),this.parentOrigin?(this.addEventListeners(),this.loadFeatureScript("Session"),this.loadFeatureScript("Broadcast"),this.addMessageHandler("script.load",function(e,s){this.loadFeatureScript(s)}.bind(this)),this.addMessageHandler("session.updateStorage",function(t,e){var s=e.deploymentId,i=JSON.parse(esw.sessionAPI.getSessionData(t,["ACTIVE_CHAT_SESSIONS"],!0).ACTIVE_CHAT_SESSIONS||"{}"),n=!1,o=!1,a=(this.isInternetExplorer()||this.isEdge())&&1===history.length&&!e.isRefresh;esw.sessionAPI.getSessionData(t,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===s&&(e.isSamePageNavigation&&!a?n=!0:esw.sessionAPI.deleteSessionData(t,["CHASITOR_SERIALIZED_KEY","MASTER_DEPLOYMENT_ID"])),esw.broadcastAPI.on("sessionStorageData",function(e){var s=JSON.parse(e.sessionStorage);this.sessionLoaded||e.domain!==t||(o=!0,Object.getOwnPropertyNames(s).forEach(function(e){-1===e.indexOf("MASTER_DEPLOYMENT_ID")&&sessionStorage.setItem(e,s[e])}),this.sessionLoaded=!0,parent.postMessage({method:"session.onLoad"},this.parentOrigin))}.bind(this)),esw.broadcastAPI.on("getSessionStorageData",function(e){e.domain===t&&(n||esw.sessionAPI.getSessionData(t,["MASTER_DEPLOYMENT_ID"]).MASTER_DEPLOYMENT_ID===e.deploymentId)&&esw.broadcastAPI.send("sessionStorageData",{sessionStorage:JSON.stringify(sessionStorage),domain:t})}),i[e.deploymentId]&&!n?(esw.broadcastAPI.send("getSessionStorageData",{deploymentId:e.deploymentId,domain:t}),setTimeout(function(){o||(this.sessionLoaded=!0,delete i[e.deploymentId],esw.sessionAPI.setSessionData(t,{ACTIVE_CHAT_SESSIONS:JSON.stringify(i)},!0),parent.postMessage({method:"session.onLoad"},this.parentOrigin))}.bind(this),500)):parent.postMessage({method:"session.onLoad"},this.parentOrigin)}.bind(this))):console.error("No domain set!")}e.prototype.isInternetExplorer=function(){return"ActiveXObject"in window},e.prototype.isEdge=function(){return!(!window.navigator||!window.navigator.userAgent||"string"!=typeof window.navigator.userAgent)&&-1<window.navigator.userAgent.indexOf("Edge")},e.prototype.log=function(e){window.devMode&&console.log(e)},e.prototype.getSafariType=function(){var e=navigator.userAgent.toLowerCase();return-1===e.indexOf("chrome")&&-1!==e.indexOf("safari")?-1===e.indexOf("mobile")?"desktop":"mobile":"none"},e.prototype.addMessageHandler=function(e,s){this.messageHandlers[e]=s},e.prototype.addEventListeners=function(){window.addEventListener("message",function(e){var s,t,i,n,o=e.data;if(o&&o.method){if(t=e.origin.indexOf("://")+3,i=(i=e.origin.substring(t)).split(":")[0],(s=o.domain)&&".force.com"===i.substr(-".force.com".length)&&(s=s.split("/")[0]),e.origin!==window.esw.parentOrigin.substr(0,e.origin.length))return void console.log("Message origin must match parent origin!");if(i!==s&&-1===i.indexOf("."+s,i.length-s.length-1))return void console.log("storageDomain ("+o.domain+") must be a parent of message origin domain ("+i+")!");n=o.method.split(".")[0].toLowerCase(),-1===this.availableFeatures.indexOf(n)?(this.pendingMessages[n]||(this.pendingMessages[n]=[]),this.pendingMessages[n].push(o)):this.handleMessage(o)}}.bind(this),!1)},e.prototype.handleMessage=function(e){this.messageHandlers[e.method]?this.messageHandlers[e.method](e.domain,e.data):console.log("Unregistered method "+e.method+" received in frame.")},e.prototype.defineFeature=function(e,s){this.featureScripts[e]=s},e.prototype.loadFeatureScript=function(e,s){var t,i=(e=decodeURI(e)).toLowerCase();if(-1!==e.indexOf(".."))throw new Error('"'+e+'" is not a valid feature name.');(t=document.createElement("script")).type="text/javascript",t.src="frame/"+i+".esw"+(window.devMode?"":".min")+".js",t.onload=function(){this.featureScripts[e](this),s&&s(),this.availableFeatures.push(i),this.processPendingMessages(i)}.bind(this),document.body.appendChild(t)},e.prototype.postMessage=function(e,s){parent.postMessage({method:e,data:s},this.parentOrigin)},e.prototype.processPendingMessages=function(e){this.pendingMessages[e]&&(this.pendingMessages[e].forEach(function(e){this.handleMessage(e)}.bind(this)),this.pendingMessages[e]=void 0)},window.esw=new e}();