var SearchArea=eg.Class({construct:function($el,options){this._setVar($el,options);this._setEvent();if(options.keyword&&options.keyword!=""){this._instance.searchHistory.add(options.keyword)}},_setVar:function($el,options){this._MAX_LIST_COUNT=10;this._locale=options.locale;this._autoCompleteUrl=options.autoCompleteUrl;this._messages=options.message;this._imageDomain=options.imgDomain;var wrap=$el;this._ui={wrap:wrap,searchArea:wrap.find("._searchArea"),keyword:wrap.find("._txtKeyword"),desc:wrap.find("._searchDesc"),searchIcon:wrap.find("._icoSearch"),deleteButton:wrap.find("._btnDelete"),searchLayer:wrap.find("._searchLayer")};this._template={searchHistoryList:Handlebars.compile($("#searchHistoryListTemplate").html()),searchHistoryItem:Handlebars.compile($("#searchHistoryItemTemplate").html()),autoCompleteList:Handlebars.compile($("#autoCompleteListTemplate").html()),autoCompleteTitleItem:Handlebars.compile($("#autoCompleteTitleItemTemplate").html()),autoCompleteAuthorItem:Handlebars.compile($("#autoCompleteAuthorItemTemplate").html()),autoCompleteKeyword:Handlebars.compile($("#autoCompleteKeywordTemplate").html()),};this._autoCompleteKeywordList=[];this._instance={searchHistory:new SearchHistory(),watchInput:new WatchInput(this._ui.keyword.get(0))}},_setEvent:function(){this._ui.wrap.on("click","._btnSearch",$.proxy(this._onClickSearchButton,this));this._ui.searchArea.on("click","._searchForm ._btnClose",$.proxy(this._onClickSearchCloseButton,this)).on("click","._searchForm ._btnDelete",$.proxy(this._onClickDeleteButton,this)).on("click","._searchDesc",$.proxy(this._onFocusSearchForm,this)).on("click","._searchLayer ._btnDeleteHistory",$.proxy(this._onClickDeleteHistoryButton,this)).on("click","._searchLayer ._btnClose",$.proxy(this._onClickAutoCompleteCloseButton,this)).on("keyup","._txtKeyword",$.proxy(this._onKeyupKeyword,this)).on("mouseover","._searchLayer",$.proxy(this._onMouseOverSearchLayer,this));this._instance.watchInput.on("focus",$.proxy(this._onFocusSearchForm,this)).on("blur",$.proxy(this._onBlurSearchForm,this)).on("change",$.proxy(this._onInputSearchKeyword,this))},_onClickSearchButton:function(e){e.preventDefault();this._ui.searchArea.show();this._ui.keyword.get(0).focus();var keyword=this._getSearchKeyword();if(keyword){this._ui.desc.hide()}},_onClickSearchCloseButton:function(e){e.preventDefault();this._ui.searchArea.hide()},_onClickDeleteButton:function(e){e.preventDefault();this._ui.keyword.val("");this._onInputSearchKeyword(e);this._ui.keyword.get(0).focus()},_onFocusSearchForm:function(e){var keyword=this._getSearchKeyword();if(!keyword){this._ui.desc.hide();this._ui.keyword.get(0).focus();this._openSearchHistoryLayer()}},_onBlurSearchForm:function(e){if(!this._getSearchKeyword()){this._ui.desc.fadeIn();setTimeout($.proxy(function(){this._closeSearchLayer()},this),300)}},_onInputSearchKeyword:function(e){var keyword=this._getSearchKeyword();if(!keyword){this._ui.searchIcon.show().css("display","inline-block");this._ui.deleteButton.hide();this._closeSearchLayer();this._openSearchHistoryLayer()}else{this._ui.searchIcon.hide();this._ui.deleteButton.show().css("display","inline-block");this._autoComplete(keyword)}},_onClickDeleteHistoryButton:function(e){e.preventDefault();if(confirm(this._messages["confirm.search.delete_history"])){this._instance.searchHistory.remove();this._closeSearchLayer()}},_onClickAutoCompleteCloseButton:function(e){this._closeSearchLayer()},_onKeyupKeyword:function(e){var key=e.which;var selected=this._ui.searchLayer.find("li.on");if(key===13){if(selected.length){if(this._ui.searchLayer.hasClass("_autoComplete")){var url=selected.find("a._searchItem").attr("href");location.href=url;return}else{if(this._ui.searchLayer.hasClass("_searchHistory")){this._ui.keyword.val(selected.text())}}}this._goSearch()}else{if(this._ui.searchLayer.visible()&&key.up){if(!selected.length){var last=this._ui.searchLayer.find("ul.creator li:nth-last-of-type(1)")||this._ui.searchLayer.find("ul li:nth-last-of-type(1)");last.addClass("on")}else{selected.removeClass("on");var next=selected.prev();if(!next.length){next=this._ui.searchLayer.find("ul li:nth-last-of-type(1)");if(!next.length||selected.parent().hasClass("creator")==false){return}else{next.addClass("on")}}else{next.addClass("on")}}}else{if(this._ui.searchLayer.css("display")!=="none"&&key.down){if(!selected.length){this._ui.searchLayer.find("li:first-of-type").addClass("on")}else{selected.removeClass("on");var next=selected.next();if(!next.length){next=this._ui.searchLayer.find("ul.creator li:first-of-type");if(!next.length||selected.parent().hasClass("creator")){return}else{next.addClass("on")}}else{next.addClass("on")}}}}}},_onMouseOverSearchLayer:function(e){var selected=this._ui.searchLayer.find("li.on");selected.removeClass("on")},_openSearchHistoryLayer:function(){if(this._ui.searchLayer.hasClass("_searchHistory")){return}var keyword=this._instance.searchHistory.get();if(keyword&&keyword.length>0){this._ui.searchLayer.addClass("_searchHistory");var htmlList=[];for(var i=0,n=Math.min(keyword.length,this._MAX_LIST_COUNT);i<n;i++){htmlList.push(this._template.searchHistoryItem({keyword:Util.replaceEncodedChars(keyword[i])}))}var html=this._template.searchHistoryList({searchHistoryListHtml:htmlList.join("\n")});this._ui.searchLayer.empty().append(html).show()}},_closeSearchLayer:function(){this._ui.searchLayer.empty().hide().removeClass("_searchHistory").removeClass("_autoComplete")},_autoComplete:function(keyword){keyword=keyword.replace(/#/g,"");this._autoCompleteKeywordList.push(keyword.toLowerCase());$.ajax({url:Util.stringFormat(this._autoCompleteUrl,this._locale,keyword),dataType:"jsonp",jsonp:"_callback",method:"GET",timeout:1000}).then($.proxy(this._autoCompleteResponse,this)).fail(function(){})},_goSearch:function(keyword){keyword=keyword||this._getSearchKeyword();if(keyword){location.href="/search?keyword="+encodeURIComponent(keyword)}},_getSearchKeyword:function(){var keyword=this._ui.keyword.val();return Util.stripHTML(Util.stripScripts(Util.trim(keyword)))},_autoCompleteResponse:function(res){var keyword=res.query[0].replace(this._locale+"\x11","");var keywordIndex=this._autoCompleteKeywordList.indexOf(keyword);if(keywordIndex==-1&&this._autoCompleteKeywordList.length>0){return}for(var i=0;i<this._autoCompleteKeywordList.indexOf(keyword);i++){this._autoCompleteKeywordList.shift()}var items=res.items[0];if(!items||items.length==0){this._closeSearchLayer();return}Util.getGenreNameMap().then($.proxy(function(genreNameMap){var titleHtml=[];var aAuthorHtml=[];var reg=new RegExp("("+keyword+")","ig");for(var i=0,n=items.length;i<n;i++){var item=items[i];var type=item[1][0];if(type=="TITLE"){var keywordHtml=item[0][0].replace(reg,this._template.autoCompleteKeyword({keyword:"$1"}));titleHtml.push(this._template.autoCompleteTitleItem({keyword:keywordHtml,title:item[0][0],starScoreAverage:Util.changeStarScoreFormat(item[2][0]),titleNo:parseInt(item[3][0]),mobileThumbnail:item[4][0],authorName:Util.getAuthorName(item[6][0],item[7][0]),representGenre:genreNameMap[item[8][0]]}))}else{if(type=="AUTHOR"){var keywordHtml=item[0][0].replace(reg,this._template.autoCompleteKeyword({keyword:"$1"}));var titleNames='<span class="subj2">'+item[3][0].replace("||",'</span> <em class="bar">|</em> <span class="subj2">')+"</span>";aAuthorHtml.push(this._template.autoCompleteAuthorItem({keyword:keywordHtml,authorName:item[0][0],titleNames:titleNames}))}}}var html=this._template.autoCompleteList({isExistsTitleListHtml:titleHtml.join("\n")!="",isExistsAuthorListHtml:aAuthorHtml.join("\n")!="",titleListHtml:titleHtml.join("\n"),authorListHtml:aAuthorHtml.join("\n"),keyword:keyword});this._ui.searchLayer.empty().html(html).show().addClass("_autoComplete").removeClass("_searchHistory")},this))}});var SearchHistory=eg.Class({construct:function(){this._LOCAL_STORAGE_NAME="searchHistory";this._MAX_COUNT=100;this._localStorage=new LocalStorageUtil()},add:function(keyword){var searchHistory=this.get();for(var i=0,l=searchHistory.length;i<l;i++){if(searchHistory[i]==keyword){searchHistory.splice(i,1);break}}var newSearchHistory=[keyword];newSearchHistory=newSearchHistory.concat(searchHistory);newSearchHistory.splice(this._MAX_COUNT,this._MAX_COUNT);for(var i=0;i<newSearchHistory.length;i++){newSearchHistory[i]=Util.replaceEncodedChars(newSearchHistory[i])}this._localStorage.set(this._LOCAL_STORAGE_NAME,newSearchHistory);return newSearchHistory},get:function(){return this._localStorage.get(this._LOCAL_STORAGE_NAME)||[]},remove:function(keyword){if(!keyword){this._localStorage.remove(this._LOCAL_STORAGE_NAME);return}var searchHistory=this.get();for(var i=0,l=searchHistory.length;i<l;i++){if(searchHistory[i]==keyword){searchHistory.splice(i,1);break}}this._localStorage.set(this._LOCAL_STORAGE_NAME,searchHistory);return searchHistory}});
var Timer=eg.Class.extend(eg.Component,{construct:function(){this._timerId=null;this._lastRunTime=null;this._remainedTime=0;this._delay=null;this._timerHandler=null;this._isRunning=false},start:function(timerHandler,delay){this.abort();this._remainedTime=0;this._delay=delay;this._timerHandler=timerHandler;this._isRunning=true;this._lastRunTime=this._getTime();this.trigger("wait");this._excute(this._delay,false);return true},isRunning:function(){return this._isRunning},_getTime:function(){return new Date().getTime()},_clearTimer:function(){var isAborted=false;if(this._timerId){clearInterval(this._timerId);this._isRunning=false;isAborted=true}this._timerId=null;return isAborted},abort:function(){var isAborted=this._clearTimer();if(isAborted){this.trigger("abort");this._timerHandler=null}return isAborted},pause:function(){var passedTime=this._getTime()-this._lastRunTime;this._remainedTime=Math.max(this._delay-passedTime,0);return this._clearTimer()},_excute:function(delay,hasResetDelay){this._clearTimer();this._isRunning=true;var launcher=$.proxy(function(isDontUseTimer){if(this._timerId||isDontUseTimer){this.trigger("run");var r=this._timerHandler();this._lastRunTime=this._getTime();if(!r){if(!isDontUseTimer){clearInterval(this._timerId)}this._timerId=null;this._isRunning=false;this.trigger("end");return}this.trigger("wait");if(hasResetDelay||isDontUseTimer){this._excute(this._delay,false)}}},this);if(delay>-1){this._timerId=setInterval(launcher,delay)}else{launcher(true)}},resume:function(){if(!this._timerHandler||this.isRunning()){return false}this._isRunning=true;this.trigger("wait");this._excute(this._remainedTime,true);this._remainedTime=0;return true}});
var WatchInput=eg.Class.extend(eg.Component,{_isTimerRunning:false,_isFocused:false,_prevValue:"",construct:function(inputId,option){var defaultOption={interval:100,isUseTimerOnIE:false,keyEventName:"keyup",isPermanent:false,isActivateOnload:true};this.option(defaultOption);this.option(option||{});this._inputElement=$(inputId)[0];this._timer=new Timer();this._isIE=eg.agent().browser.name==="ie";this._wfFocus=$.proxy(this._onFocus,this);this._wfBlur=$.proxy(this._onBlur,this);this._wfKeyEvent=$.proxy(this._onKeyEvent,this);this._wfStartTimer=$.proxy(this._startTimer,this);this._wfStopTimer=$.proxy(this._stopTimer,this);if(this.option("isActivateOnload")){this._onActivate(true)}},getInput:function(){return this._inputElement},setInputValue:function(s){this.getInput().value=s;this.setCompareValue(s);return this},getCompareValue:function(){return this._prevValue},setCompareValue:function(s){this._prevValue=s;return this},fireChangeEvent:function(){var inputElement=this.getInput(),value=inputElement.value;this.setCompareValue(value);this.trigger("change",{inputElement:inputElement,text:value});return this},start:function(isCompareOnce){return this.activate(isCompareOnce||false)},stop:function(){return this.deactivate()},_onActivate:function(isCompareOnce){this.setCompareValue("");var inputElement=$(this.getInput());inputElement.on("focus",this._wfFocus);if(this._isIE&&!this.option("isUseTimerOnIE")){this.trigger("start");inputElement.on(this.option("keyEventName"),this._wfKeyEvent)}else{if(this._isTimerRunning){return}this.trigger("start");if(this.option("isPermanent")){this._startTimer()}else{inputElement.on("focus",this._wfStartTimer);inputElement.on("blur",this._wfStopTimer)}}inputElement.on("blur",this._wfBlur);if(isCompareOnce||false){this.compare()}},_onDeactivate:function(){var inputElement=this.getInput();inputElement.off("focus",this._wfFocus);inputElement.off(this.option("keyEventName"),this._wfKeyEvent);this._stopTimer();inputElement.off("focus",this._wfStartTimer);inputElement.off("blur",this._wfStopTimer);inputElement.off("blur",this._wfBlur);this.trigger("stop")},getInterval:function(){return this.option("interval")},setInterval:function(n){this.option("interval",n);return this},_startTimer:function(){if(this._isTimerRunning){return}this._isTimerRunning=true;this.trigger("timerStart");this.compare();var self=this;this._timer.start(function(){self.compare();return true},this.getInterval())},_stopTimer:function(){if(this._isTimerRunning){this._timer.abort();this._isTimerRunning=false;this.compare();this.trigger("timerStop")}},_onKeyEvent:function(){this.compare()},_onFocus:function(){this._isFocused=true;this.trigger("focus")},_onBlur:function(){this._isFocused=false;this.trigger("blur")},compare:function(){if(this.getInput().value!=this.getCompareValue()){this.fireChangeEvent()}return this}});
var LayerManager=eg.Class.extend(eg.Component,{_isActivating:false,_isHiding:false,_isShowing:false,_linkList:null,construct:function(el,option){this._option={checkEventName:"click",checkDelay:100,showDelay:0,hideDelay:100};this._eventHandlerMap={};$.extend(this._option,option);this.setLayer(el);this._linkList=[];this._showTimer=new Timer();this._hideTimer=new Timer();this._eventTimer=new Timer();this.getVisible();$(document).on(this._option.checkEventName,$.proxy(this._onEvent,this))},getVisible:function(){return this._wel.is(":visible")},_check:function(el){for(var i=0,elLink,welLink;(elLink=this._linkList[i]);i++){welLink=$(elLink);if(welLink.length){elLink=welLink[0];if(elLink&&el&&(el==elLink||$.contains(elLink,el))){return true}}}return false},_find:function(el){var wel=$(el);if(wel.length){el=wel[0];for(var i=0,elLink;(elLink=this._linkList[i]);i++){if(elLink==el){return i}}}return -1},getLayer:function(){return this._el},setLayer:function(el){this._wel=$(el);this._el=this._wel[0];return this},getLinks:function(){return this._linkList},link:function(element){if(arguments.length>1){for(var i=0,len=arguments.length;i<len;i++){this.link(arguments[i])}return this}if(this._find(element)!=-1){return this}this._linkList.push(element);return this},_triggerBeforeShow:function(){return this.trigger("beforeShow",{layer:this.getLayer(),linkedElementList:this.getLinks()})},_triggerShow:function(){this._isShowing=false;this.trigger("show",{layer:this.getLayer(),linkedElementList:this.getLinks()})},_triggerBeforeHide:function(){var result=this.trigger("beforeHide",{layer:this.getLayer(),linkedElementList:this.getLinks()});if(!result){this._isHiding=false}return result},_triggerHide:function(){this._isHiding=false;this.trigger("hide",{layer:this.getLayer(),linkedElementList:this.getLinks()})},_show:function(showHandler,delay){this._eventTimer.abort();this._isShowing=true;this._isHiding=false;if(delay<=0){this._hideTimer.abort()}this._showTimer.start(function(){showHandler()},delay)},_hide:function(hideHandler,delay){this._isShowing=false;this._isHiding=true;if(delay<=0){this._showTimer.abort()}this._hideTimer.start(function(){hideHandler()},delay)},show:function(delay){if(typeof delay=="undefined"){delay=this._option.showDelay}this._show($.proxy(function(){if(!this.getVisible()){if(this._triggerBeforeShow()){this._wel.show();this._triggerShow()}}},this),delay);return this},hide:function(delay){if(typeof delay=="undefined"){delay=this._option.hideDelay}this._hide($.proxy(function(){if(this.getVisible()){if(this._triggerBeforeHide()){this._wel.hide();this._triggerHide()}}},this),delay);return this},toggle:function(delay){if(!this.getVisible()||this._isHiding){this.show(delay||this._option.showDelay)}else{this.hide(delay||this._option.hideDelay)}return this},_onEvent:function(event){var el=event.target;this._eventTimer.start($.proxy(function(){if(!this._isHiding&&this.getVisible()){if(this._check(el)){if(!this._isShowing){this.trigger("ignore",{checkEventName:this._option.checkEventName});this._hideTimer.abort();this._isHiding=false}}else{if(typeof el.tagName!=="undefined"&&el.tagName!=="OPTION"){this.hide()}}}},this),this._option.checkDelay)},});
var Gnb=eg.Class({construct:function(option){this._gnbLayer=$(option.gnbLayerId);if(!this._gnbLayer){return}new LoginArea(this._gnbLayer,option.message);new SearchArea(this._gnbLayer,option.searchParam)}});var LoginArea=eg.Class({construct:function(parentLayer,message){this._message=message;this._parentLayer=parentLayer;Util.getUserInfo().then($.proxy(function(userInfo){if(userInfo!=null&&userInfo.isLogin==true){if(window.location.href.indexOf("noLogin=true")<0&&userInfo.needLogout==true){location.href="/member/logout?returnUrl="+encodeURIComponent(location.href);return}if(userInfo.isSignup==true){this._setupLoggedIn(userInfo)}else{if(window.location.href.indexOf("noLogin=true")<0){new SignUp(this._setupLoggedIn)}else{$("#btnLogin").hide()}}}else{new Login({layerId:"#layerMy",message:{systemerror:this._message.systemErrorMessage}})}},this));this._parentLayer.on("mouseover","#btnLoginInfo",$.proxy(this._openLoginLayer,this)).on("click","#btnLoginInfo",$.proxy(this._goMyWebtoonPage,this)).on("click","#btnLogin",$.proxy(this._openLoginLayer,this)).on("click","._btnLogout",$.proxy(this._logout,this)).on("click","#btnPublish",$.proxy(this._checkLoginForPublish,this));new LayerManager("#layerMy",{checkEventName:"mouseover"}).on("hide",function(){$("#layerMy").removeClass("on")}).on("show",function(){$("#layerMy").addClass("on")}).link($("#btnLoginInfo")[0]).link($("#btnLogin")[0]).link($("#layerMy")[0])},_setupLoggedIn:function(userInfo){this._snsCode=userInfo.snsCode;userInfo.snsName=userInfo.snsCode.toLowerCase();userInfo.nickname=Util.replaceEncodedChars(userInfo.nickname);var btnTemplate=Handlebars.compile('<em class="ico_user"></em>{{nickname}}');$("#btnLoginInfo").html(btnTemplate(userInfo)).show().css("display","inline-block").attr("title",userInfo.nickname);$("#btnLogin").hide();var myLayerTemplate=Handlebars.compile($("#tplMyLayer").html());$("#layerMy").empty().html(myLayerTemplate(userInfo)).addClass("favorites")},_openMyLayer:function(){$("#layerMy").addClass("on").show()},_openLoginLayer:function(e){e.preventDefault();$("#layerMy").addClass("on").show().css("display","inline-block")},_goMyWebtoonPage:function(e){e.preventDefault();location.href="/favorite"},_logout:function(e){e.preventDefault();if(confirm(this._message.logoutMessage)==true){location.href="/member/logout?returnUrl="+encodeURIComponent(location.href)}return false},_checkLoginForPublish:function(e){e.preventDefault();var publishUrl="https://"+window.location.hostname+"/challenge/publish";Util.checkLoginStatus().then(function(isLoggedIn){if(!isLoggedIn){Util.goLogin(publishUrl);return $.Deferred().reject()}location.href=publishUrl})},});var SignUp=eg.Class({construct:function(setupLoggedInFunction){this._setupLoggedIn=setupLoggedInFunction;this._showLayer()},_showLayer:function(){var layerTemplate=Handlebars.compile($("#tplSignUp").html());var signUpLayer=$("<div id='signUpLayer'></div>");signUpLayer.append(layerTemplate());$(document.body).append(signUpLayer);signUpLayer.on("click",".input_chk",function(){$(".ico_chkbox2").first().toggleClass("on")});signUpLayer.on("click","._signUp",$.proxy(this._signUp,this))},_signUp:function(event){event.preventDefault();if(!$("#signup_chk_term").prop("checked")){$("#_pleaseAgree").show();return}$.ajax("/member/signupProcess").then(this._onLoadSignUp)},_onLoadSignUp:function(){window.location.reload()}});
